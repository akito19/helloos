# Day 20

### 1. プログラムの整理

リファクタ

### 2, 3. 一文字表示API

`CALL` 命令は `JMP` 命令とほぼ同じ．ただし， `RET` 命令によって戻ってくるために， `CALL` にはスタックに戻り先のメモリ番地をPUSHする必要がある．

```asm
MOV   AL,'A'
CALL  `some memory address...`
```

相変わらず `hlt` で再起動っぽいのが起こる...
なにゆえ...

### 4. アプリケーションの終了

### 5. OSのバージョンが変わっても変わらないAPI

OSがアップデートするたびに呼びたい関数のメモリ番地が変わるので，アプリ側でそれを追従しようとするのはめんどくさい．

なので，コンパイルしなおしたりしなくても問題ないようにする．
ここでは `IDT` の未使用部分を利用して `asm_cons_putchar` を登録してしまう．

### 6. アプリケーション名を自由に

### 7, レジスタに気をつけよう

qemu が死ぬ．

```
KVM internal error. Suberror: 1
emulation failure
EAX=4ffffd01 EBX=0000002c ECX=00000014 EDX=00271f00
ESI=0000001c EDI=0000003f EBP=00054d40 ESP=00054ce8
EIP=00000140 EFL=00010202 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0
ES =0008 00000000 ffffffff 00c09300 DPL=0 DS   [-WA]
CS =1f58 0005b027 000021e6 00409b00 DPL=0 CS32 [-RA]
SS =0008 00000000 ffffffff 00c09300 DPL=0 DS   [-WA]
DS =0008 00000000 ffffffff 00c09300 DPL=0 DS   [-WA]
FS =0008 00000000 ffffffff 00c09300 DPL=0 DS   [-WA]
GS =0008 00000000 ffffffff 00c09300 DPL=0 DS   [-WA]
LDT=0000 00000000 00000000 00000000
TR =0028 0000514c 00000067 00008b00 DPL=0 TSS32-busy
GDT=     00270000 0000ffff
IDT=     0026f800 000007ff
CR0=00000019 CR2=00000000 CR3=00000000 CR4=00000000
DR0=00000000 DR1=00000000 DR2=00000000 DR3=00000000
DR6=ffff0ff0 DR7=00000400
EFER=0000000000000000
Code=65 78 74 00 2e 73 68 73 74 72 74 61 62 00 2e 73 79 6d 74 61 <62> 00 2e 73 74 72 74 61 62 00 2e 72 65 6c 2e 74 65 78 74 00 00 00 00 00 00 00 00 00 00 00
```

