# Day 15

### マルチタスク

執筆時点での一般的なOSのタスクの切り替え時間は 0.01 ~ 0.03 秒ほど．これはタスクスイッチ（CPUのタスク切り替え）に要する時間を含むので，もしこれより切り替え時間を短くすると，タスクスイッチに必要な時間分を差し引いた作業時間がより短くなり，体感的にはよりもっさりとした動作に感じるかもしれない．

マルチタスクを実行するときのCPUの挙動

1. CPUがレジスタの値をメモリに書き込む
  * タスクを切り替える前にこれまでの作業状態を保持
2. CPUが次に実行するタスクのレジスタの値をメモリから読み込む
3. 以下繰り返し

レジスタの内容がメモリに書き込まれるとき，Task State Segment という構造体が使われ，これをGDTで設定して利用する．

```c
struct TSS32 {
    int backlink, esp0, ss0, esp1, ss1, esp2, ss2, cr3;
    int eip, eflags, eax, ecx, edx, ebx, esp, ebp, esi, edi; // 32bit registers
    int es, cs, ss, ds, fs, gs; // 16bit registers
    int ldtr, iomap;
};
```

以上のような，26個104バイトの`int`からなる構造体．
`eip` は `Extend Instruction Pointer`で，次に実行する命令が入ったメモリ番地を記憶するためのレジスタ．

タスクスイッチを行うときは `JMP` 命令を用いてタスクを切り替える．
`JMP` には

* `near` mode
  * `EIP` だけを切り替える
* `far` mode
  * `EIP` と `CS`(Code Segment register)の療法を同時に切り替える

の2種類がある． `far` モードの起動は以下のように， `JMP` で指定した番地に `:` を入れることで実行する．

```asm
: asmhead.asm
JMP   DWORD 2*8:0x0000001b
```

この場合，`EIP` に `0x1b` を代入し， `CS` に `2 * 8` を代入する．

さらに

```asm
taskswitch:  ; void taskswitch(void);
    JMP   4*8:0
    RET
```

のように，`JMP` のあとに `RET` を書いたりもする．通常の `JMP` ではジャンプしたあと戻ってこないので， `RET` があろうとなかろうと実行されないが，タスクスイッチの場合は，該当タスクに戻ってきたときに `JMP` の次の命令から処理が再開するので，スイッチ先から戻ってきた直後にアセンブラの処理を抜けてC言語のプログラムなどアプリケーション側に処理を戻したいような場合は `RET` しておく．
